<%# app/views/collections/show.html.erb %>

<div class="max-w-7xl mx-auto mt-8 px-7 py-8">
  <div class="mb-4">
    <%= link_to "My Collections", collections_path,
        class: "text-white px-3 py-1 rounded-xl bg-goldenrod hover:bg-golden-brown hover:text-gray-100 font-semibold" %>
    <div class="flex items-center justify-between mt-4">
      <div>
        <h1 class="text-4xl font-bold"><%= @collection.name %></h1>
        <p class="text-gray-600 mt-1">
          <%= pluralize(@collection_cards.size, "card") %>
          <% total = @collection_cards.sum { |cc| (cc.card.cardmarket_price || 0) * cc.quantity } %>
          <% if total > 0 %>
            • €<%= format('%.2f', total) %> total value
          <% end %>
        </p>
        <% if @collection.description.present? %>
          <p class="text-gray-500 mt-1 text-sm"><%= @collection.description %></p>
        <% end %>
      <%= link_to "Edit", edit_collection_path(@collection),
          class: "text-sm font-semibold text-gray-400 hover:text-umber transition-colors" %>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div data-controller="toggle" data-toggle-open-value="<%= params[:q].present? || params[:rarity].present? || params[:type].present? %>">
    <button type="button"
            data-action="click->toggle#toggle"
            class="w-full mb-4 flex items-center justify-between bg-gray-50 rounded-xl p-2 border-2 border-gray-200 hover:border-umber hover:text-goldenrod transition-colors cursor-pointer">
      <span class="font-semibold text-gray-700 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        Filters
        <% if params[:q].present? || params[:rarity].present? || params[:type].present? %>
          <span class="px-2 py-0.5 bg-umber text-white text-xs rounded-full">Active</span>
        <% end %>
      </span>
      <svg data-toggle-target="icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>

    <div data-toggle-target="content" class="hidden">
      <%= form_with url: collection_path(@collection), method: :get, class: "mb-6 bg-white rounded-xl pt-6 px-6 p-2 border-2 border-gray-200", data: { turbo_frame: "_top", controller: "auto-submit" } do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div class="lg:col-span-2">
            <%= f.text_field :q,
                value: params[:q],
                placeholder: "Search cards in this collection...",
                class: "w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-umber focus:outline-none" %>
          </div>

          <div>
            <%= f.select :rarity,
                [
                  ['Rarities', ''],
                  ['Common', 'common'],
                  ['Uncommon', 'uncommon'],
                  ['Rare', 'rare'],
                  ['Mythic', 'mythic']
                ],
                { selected: params[:rarity] },
                {
                  class: "w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-umber focus:outline-none",
                  data: { action: "change->auto-submit#submit" }
                } %>
          </div>

          <div>
            <%= f.select :type,
                [
                  ['Types', ''],
                  ['Creature', 'Creature'],
                  ['Instant', 'Instant'],
                  ['Sorcery', 'Sorcery'],
                  ['Enchantment', 'Enchantment'],
                  ['Artifact', 'Artifact'],
                  ['Planeswalker', 'Planeswalker'],
                  ['Land', 'Land'],
                  ['Battle', 'Battle']
                ],
                { selected: params[:type] },
                {
                  class: "w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-umber focus:outline-none",
                  data: { action: "change->auto-submit#submit" }
                } %>
          </div>

          <div>
            <%= f.select :sort,
                [
                  ['Recent First', 'recent'],
                  ['Name (A-Z)', 'name_asc'],
                  ['Name (Z-A)', 'name_desc'],
                  ['Set (A-Z)', 'set_asc'],
                  ['Set (Z-A)', 'set_desc'],
                  ['Price ↑', 'price_asc'],
                  ['Price ↓', 'price_desc']
                ],
                { selected: params[:sort] || 'recent' },
                {
                  class: "w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-umber focus:outline-none",
                  data: { action: "change->auto-submit#submit" }
                } %>
          </div>

          <div class="flex gap-2">
            <%= f.submit "Filter", class: "flex-1 py-2.5 bg-umber text-white rounded-lg font-semibold hover:bg-golden-brown transition-colors cursor-pointer" %>
            <% if params[:q].present? || params[:rarity].present? || params[:type].present? %>
              <%= link_to "Clear", collection_path(@collection), class: "px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Cards Grid -->
  <% if @collection_cards.any? %>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
      <% @collection_cards.each do |cc| %>
        <%= link_to collection_card_path(cc), class: "group" do %>
          <div class="relative overflow-hidden rounded-lg">
            <% if cc.card.image_url.present? %>
              <%= image_tag cc.card.image_url,
                  alt: cc.card.name,
                  class: "w-full rounded-xl shadow-xl",
                  loading: "lazy" %>
            <% else %>
              <div class="w-full aspect-[2.5/3.5] bg-gray-200 rounded-lg shadow-md flex items-center justify-center">
                <span class="text-gray-400 text-sm">No image</span>
              </div>
            <% end %>

            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center rounded-xl">
              <span class="text-white text-md font-semibold">Details</span>
            </div>

            <% if cc.quantity > 1 %>
              <div class="absolute top-2 right-2 bg-umber text-white text-xs font-bold px-2 py-0.5 rounded-full shadow">
                ×<%= cc.quantity %>
              </div>
            <% end %>

            <% if cc.foil? %>
              <div class="absolute top-2 left-2 bg-goldenrod text-white text-xs font-bold px-2 py-0.5 rounded-full shadow">
                ✦
              </div>
            <% end %>
          </div>
          <p class="text-sm text-center mt-2 text-gray-700 group-hover:text-umber truncate font-semibold">
            <%= cc.card.name %>
          </p>
          <p class="text-xs text-center text-gray-500 capitalize">
            <%= cc.card.rarity %>
            <% if cc.card.cardmarket_price.present? %>
              • €<%= format('%.2f', cc.card.cardmarket_price) %>
            <% end %>
          </p>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="text-center bg-white rounded-lg border-2 border-gray-300 pb-4 pt-4">
      <h3 class="text-lg font-bold text-gray-900">No cards in this collection</h3>
      <p class="mt-1 text-sm text-gray-500">Start browsing sets and adding cards!</p>
      <%= link_to "Browse Sets", sets_path,
          class: "mt-4 inline-block bg-umber hover:bg-golden-brown text-white font-semibold px-4 py-2 rounded-xl transition-colors" %>
    </div>
  <% end %>
</div>
